---
- name: Install and onboard Microsoft Defender for Endpoint
  hosts: localhost
  vars_files:
    - settings.yaml

  tasks:
    - name: Create a directory if it does not exist
      ansible.builtin.file:
        path: /tmp/mde_install
        state: directory
        mode: '0755'

    - name: Download Onboarding script
      ansible.builtin.get_url:
        url: "{{ mde_onboarding_url }}"
        dest: /tmp/mde_install/mdatp_onboard.json
        mode: '0700'

    - name: Install MDE on host
      ansible.builtin.script: "{{ mde_installer_script }} --install --onboard /tmp/mde_install/mdatp_onboard.json --verbose --log-path {{ mde_installer_log }}"
